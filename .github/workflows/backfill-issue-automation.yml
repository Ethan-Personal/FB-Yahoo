name: Backfill - Issue Automation

on:
  workflow_dispatch:
    inputs:
      state:
        description: 'Issue state to backfill (open or all)'
        required: true
        default: open
        type: choice
        options:
          - open
          - all
      limit:
        description: 'Max issues to process (API-friendly)'
        required: true
        default: '200'
        type: string

permissions:
  contents: read

jobs:
  backfill:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.ORG_WORKFLOW_TOKEN }}
      REPO: ${{ github.repository }}

    steps:
      - name: Backfill by touching issues (triggers issues:edited workflows)
        shell: bash
        run: |
          set -euo pipefail

          STATE="${{ inputs.state }}"
          LIMIT="${{ inputs.limit }}"

          echo "Repo: $REPO"
          echo "State: $STATE"
          echo "Limit: $LIMIT"

          # Build search query
          if [ "$STATE" = "open" ]; then
            QUERY="repo:$REPO is:issue is:open"
          else
            QUERY="repo:$REPO is:issue"
          fi

          echo "Searching issues: $QUERY"

          # Get issue numbers (excluding PRs automatically by is:issue)
          # Using gh search so we don't need pagination logic here.
          mapfile -t ISSUES < <(gh search issues "$QUERY" --limit "$LIMIT" --json number --jq '.[].number')

          echo "Found ${#ISSUES[@]} issues to backfill."

          if [ "${#ISSUES[@]}" -eq 0 ]; then
            echo "Nothing to do."
            exit 0
          fi

          # Touch each issue body to trigger 'edited' event.
          # Use an HTML comment marker that won't affect templates visually.
          for N in "${ISSUES[@]}"; do
            echo "----"
            echo "Touching #$N"

            BODY=$(gh api "repos/$REPO/issues/$N" --jq '.body // ""')

            # Add marker if missing; otherwise flip whitespace to force edit.
            MARKER="<!-- automation:backfill -->"
            if echo "$BODY" | grep -q "$MARKER"; then
              NEW_BODY="${BODY} "
            else
              NEW_BODY="${BODY}"$'\n\n'"$MARKER"
            fi

            gh api "repos/$REPO/issues/$N" -f body="$NEW_BODY" > /dev/null

            # small delay to avoid rate limiting + allow downstream workflows to queue
            sleep 1
          done

          echo "Backfill touch complete."
          echo "Now wait for downstream workflows to apply labels/stage."